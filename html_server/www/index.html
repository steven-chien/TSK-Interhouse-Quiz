<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>HTML5 Server-Sent Test</title>
<link rel="stylesheet" type="text/css" href="css/index.css" />
<script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
</head>
<body>
<!--House score-->
<div class="house_container">
	<p id="A_score_box">Augustin:<span id="A"></span></p>
	<p id="D_score_box">Deusdedit:<span id="D"></span></p>
	<p id="H_score_box">Honorious:<span id="H"></span></p><br/>
	<p id="J_score_box">Justus:<span id="J"></span></p>
	<p id="L_score_box">Laurentius:<span id="L"></span></p>
	<p id="M_score_box">Mellitus:<span id="M"></span></p>
</div>

<!--Questions-->
<p><b>Question:</b></p>
<p>Question no:<input type="text" id="ID" /></p>
<p>Question:<input type="text" id="Question" /></p>

<p id="OptionContainer"></p>

<p>Answer:<input type="text" id="Answer" /></p>
<p>Path:<input type="text" id="Path" /></p>
<p>Image: <img id="myImage" src="" /></p>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<p>
  <button onclick="logger.clear()">Clear log</button>
  <button onclick="closeConnection()">Stop reconnections</button>
  <span id="connection">Connecting...</span>
</p>
<div class="border" id="log"></div>

<script type="text/javascript">
if (!window.DOMTokenList) {
  Element.prototype.containsClass = function(name) {
    return new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)").test(this.className);
  };

  Element.prototype.addClass = function(name) {
    if (!this.containsClass(name)) {
      var c = this.className;
      this.className = c ? [c, name].join(' ') : name;
    }
  };

  Element.prototype.removeClass = function(name) {
    if (this.containsClass(name)) {
      var c = this.className;
      this.className = c.replace(
          new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)", "g"), "");
    }
  };
}

// /events sends messages with text/event-stream mimetype.
var source = new EventSource('/events');

function Logger(id) {
  this.el = document.getElementById(id);
}

Logger.prototype.log = function(msg, opt_class) {
  var fragment = document.createDocumentFragment();
  var p = document.createElement('p');
  p.className = opt_class || 'info';
  p.textContent = msg;
  fragment.appendChild(p);
  this.el.appendChild(fragment);
};

Logger.prototype.clear = function() {
  this.el.textContent = '';
  var house = ["A","D","H","J","L","M", "Question", "Answer", "Path"];
  house.forEach(function(house){
	document.getElementById(house).style.backgroundColor="#FFFFFF";
	document.getElementById(house).value = 0;
  });
};

var logger = new Logger('log');

function closeConnection() {
  source.close();
  logger.log('> Connection was closed');
  updateConnectionStatus('Disconnected', false);
}

function updateConnectionStatus(msg, connected) {
  var el = document.querySelector('#connection');
  if (connected) {
    if (el.classList) {
      el.classList.add('connected');
      el.classList.remove('disconnected');
    } else {
      el.addClass('connected');
      el.removeClass('disconnected');
    }
  } else {
    if (el.classList) {
      el.classList.remove('connected');
      el.classList.add('disconnected');
    } else {
      el.removeClass('connected');
      el.addClass('disconnected');
    }
  }
  el.innerHTML = msg + '\n';
}

source.addEventListener('message', function(e) {
  if (e.origin != 'http://localhost:8000') {
    alert('Origin was not http://localhost:8000');
    return;
  }

  logger.log('lastEventID: ' + (e.lastEventId || '--') +
             ', server time: ' + e.data, 'msg');
}, false);

source.addEventListener('open', function(e) {
  logger.log('> Connection was opened');
  updateConnectionStatus('Connected', true);
}, false);

source.addEventListener('error', function(e) {
  if (e.eventPhase == 2) { //EventSource.CLOSED
    logger.log('> Connection was closed');
    updateConnectionStatus('Disconnected', false);
  }
}, false);
source.addEventListener('buzzer', function(e){	
	var data = JSON.parse(e.data);
	for(var k in data)
	{
		logger.log('>Buzzer:' + k + data[k]);
		$("#"+k+"_score_box").fadeIn(300).fadeOut(300).fadeIn(300).fadeOut(300).fadeIn(300);
	}
});
source.addEventListener('score', function(e){
	var data = JSON.parse(e.data);
	for(var k in data)
	{
		logger.log('>Score:' + k + data[k]);
		$("#"+k).html(data[k]); //change score according to house ID
	}
});
source.addEventListener('img', function(e){
	var data = JSON.parse(e.data);
	$("#myImage").attr("src", data.path);
});
source.addEventListener('question', function(e){
	logger.log('>>Question:' + e.data);
	var data = JSON.parse(e.data);
	for(var k in data)
	{
		logger.log('>Question:' + k+ " value:"+ data[k]);
		if(k != "Options")
	 	 	document.getElementById(k).value = data[k];
		else
		{
			var option_container = document.getElementById("OptionContainer");
			for (var s in data[k])
			{
				logger.log("array: " + data[k][s]);
				var label = document.createElement("label");
				label.innerHTML = data[k][s];
				var input = document.createElement("input");
				input.type = "radio";
				label.appendChild(input);
				option_container.appendChild(label); // put it into the DOM
			}
		}
	}
});
</script>
</body>
</html>
