<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>HTML5 Server-Sent Test</title>
<link rel="stylesheet" type="text/css" href="css/index.css" />
<link href="css/redmond/jquery-ui-1.10.4.custom.css" rel="stylesheet"/>
<script src="js/jquery-1.10.2.js"></script>
<script src="js/jquery-ui-1.10.4.custom.js"></script>
</head>
<body>
<!--House score-->
<div class="house_container">
	<p id="A_score_box"><span id="A"></span></p>
	<p id="D_score_box"><span id="D"></span></p>
	<p id="H_score_box"><span id="H"></span></p><br/>
	<p id="J_score_box"><span id="J"></span></p>
	<p id="L_score_box"><span id="L"></span></p>
	<p id="M_score_box"><span id="M"></span></p>
</div>
<hr/>
<!--Questions-->
<div id="QuestionContainer">
<div id="Box_Catalog" class="Box"><div id="Question_Catalog" class="question_content"></div></div>
<div id="Box_Set" class="Box"><div id="Question_Set" class="question_content"></div></div>
<div id="Box_ID" class="Box"><div id="Question_ID" class="question_content"></div></div>
<div id="Box_Question" class="Box"><div id="Question_Question" class="question_content"></div></div>

<div id="Box_Option">
  <div id="Option_A" class="question_option"></div>
  <div id="Option_B" class="question_option"></div>
  <div id="Option_C" class="question_option"></div>
  <div id="Option_D" class="question_option"></div>
</div>


<div id="Question_Answer">Answer:<input type="text" id="Answer" /></div>
<p>Path:<input type="text" id="Path" /></p>
<p>Image: <img id="myImage" src="" alt="image_loc" /></p>
</div>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<p>
  <button onclick="logger.clear()">Clear log</button>
  <button onclick="closeConnection()">Stop reconnections</button>
  <span id="connection">Connecting...</span>
</p>
<div class="border" id="log"></div>

<script type="text/javascript">
if (!window.DOMTokenList) {
  Element.prototype.containsClass = function(name) {
    return new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)").test(this.className);
  };

  Element.prototype.addClass = function(name) {
    if (!this.containsClass(name)) {
      var c = this.className;
      this.className = c ? [c, name].join(' ') : name;
    }
  };

  Element.prototype.removeClass = function(name) {
    if (this.containsClass(name)) {
      var c = this.className;
      this.className = c.replace(
          new RegExp("(?:^|\\s+)" + name + "(?:\\s+|$)", "g"), "");
    }
  };
}

// /events sends messages with text/event-stream mimetype.
var source = new EventSource('/events');

function Logger(id) {
  this.el = document.getElementById(id);
}

Logger.prototype.log = function(msg, opt_class) {
  var fragment = document.createDocumentFragment();
  var p = document.createElement('p');
  p.className = opt_class || 'info';
  p.textContent = msg;
  fragment.appendChild(p);
  this.el.appendChild(fragment);
};

Logger.prototype.clear = function() {
  this.el.textContent = '';
  var house = ["A","D","H","J","L","M", "Question", "Answer", "Path"];
  house.forEach(function(house){
	document.getElementById(house).style.backgroundColor="#FFFFFF";
	document.getElementById(house).value = 0;
  });
};

var logger = new Logger('log');

function closeConnection() {
  source.close();
  logger.log('> Connection was closed');
  updateConnectionStatus('Disconnected', false);
}

function updateConnectionStatus(msg, connected) {
  var el = document.querySelector('#connection');
  if (connected) {
    if (el.classList) {
      el.classList.add('connected');
      el.classList.remove('disconnected');
    } else {
      el.addClass('connected');
      el.removeClass('disconnected');
    }
  } else {
    if (el.classList) {
      el.classList.remove('connected');
      el.classList.add('disconnected');
    } else {
      el.removeClass('connected');
      el.addClass('disconnected');
    }
  }
  el.innerHTML = msg + '\n';
}

source.addEventListener('message', function(e) {
  if (e.origin != 'http://localhost:8000') {
    alert('Origin was not http://localhost:8000');
    return;
  }

  logger.log('lastEventID: ' + (e.lastEventId || '--') +
             ', server time: ' + e.data, 'msg');
}, false);

source.addEventListener('open', function(e) {
  logger.log('> Connection was opened');
  updateConnectionStatus('Connected', true);
}, false);

source.addEventListener('error', function(e) {
  if (e.eventPhase == 2) { //EventSource.CLOSED
    logger.log('> Connection was closed');
    updateConnectionStatus('Disconnected', false);
  }
}, false);
source.addEventListener('buzzer', function(e){	
	var data = JSON.parse(e.data);
	for(var k in data)
	{
		logger.log('>Buzzer:' + k + data[k]);
		$("#"+k+"_score_box").fadeIn(300).fadeOut(300).fadeIn(300).fadeOut(300).fadeIn(300);
	}
});
source.addEventListener('answer', function(e){  
  logger.log('>Answer:');
  $('#Question_Answer').show();
  $('#Box_Option').hide();
});
source.addEventListener('score', function(e){
	var data = JSON.parse(e.data);
	for(var k in data)
	{
		logger.log('>Score:' + k + data[k]);
		$("#"+k).html(data[k]); //change score according to house ID
	}
});
source.addEventListener('img', function(e){
	var data = JSON.parse(e.data);
	$("#myImage").attr("src", data.path);
	logger.log('>imgs:' + data.path);
});

/* UI */
source.addEventListener('ui', function(e){
  var data = JSON.parse(e.data);
  for(var k in data)
  {
    logger.log('>ui:' + k + data[k]);
    if(k == "score")
    {
      if(data[k] == "show")
        $(".house_container").show("blind", "", 1000)
      if(data[k] == "hide")
        $(".house_container").hide("blind", "", 1000)
    }
  }
});

source.addEventListener('question', function(e){
  logger.log('>>Question:' + e.data);
  $(".question_content").text("");
  $("#Box_Option div").text("");
  $('#Question_Answer').hide();
  $('#Box_Option').show();
	var data = JSON.parse(e.data);
	for(var k in data)
	{
		logger.log('>Question:' + k+ " value:"+ data[k]);
	}
  $("#Question_Catalog").text(data.Catalog);
  $("#Question_Set").text(data.Set);
  $("#Question_ID").text(data.ID);
  $("#Question_Question").text(data.Question);
  $("#Question_Answer").text(data.Answer);
  if(data.Options != null)
  {
    $("#Option_A").text(data.Options[0]);
    $("#Option_B").text(data.Options[1]);
    $("#Option_C").text(data.Options[2]);
    $("#Option_D").text(data.Options[3]);
  }
});
</script>
</body>
</html>
